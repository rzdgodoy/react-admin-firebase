import{get as e,isEmpty as r,has as t,set as n}from"lodash";import{getDownloadURL as o,ref as i,getStorage as a,uploadBytesResumable as s}from"firebase/storage";import u from"path-browserify";import{getApps as c,getApp as l,initializeApp as f}from"firebase/app";import{getAuth as d,browserSessionPersistence as h,inMemoryPersistence as v,browserLocalPersistence as m,signInWithEmailAndPassword as p,signOut as g,onAuthStateChanged as P}from"firebase/auth";import{getFirestore as y,collection as b,writeBatch as w,doc as j,serverTimestamp as R,setDoc as L,getDoc as F,updateDoc as T,deleteDoc as D,getDocs as E,query as G,limit as A,startAfter as I,where as U,orderBy as S,getCountFromServer as k}from"firebase/firestore";function _(r,t,n){r.sort(function(r,o){var i=e(r,t),a=e(o,t),s="asc"===n;return Number.isFinite(i)&&Number.isFinite(a)?C(i,a,s):"string"==typeof i&&"string"==typeof a?C(i.toLowerCase(),a.toLowerCase(),s):i instanceof Date&&a instanceof Date?C(i,a,s):C(!!i,!!a,s)})}function C(e,r,t){return e>r?t?1:-1:e<r?t?-1:1:0}function M(t,n){if(!n||r(n))return t;var o=[];return Object.keys(n).map(function(e){var r=function(e,r){if(!r||"string"==typeof r||"number"==typeof r||"boolean"==typeof r)return[{searchField:e,searchValue:r}];var t={};return t[e]=r,function(e){var r=[];return function e(t,n){for(var o in n=n||"",t)if(t.hasOwnProperty(o)){var i=t&&t[o],a=n?n+"."+o:o;"object"==typeof i||i instanceof Array?e(i,a):r.push({searchField:a,searchValue:i})}}(e,null),r}(t)}(e,n[e]);o.push.apply(o,r)}),t.filter(function(r){return o.reduce(function(t,n){var o=function(r,t,n){var o=e(r,t);return!o&&!n||!!o&&("string"==typeof n?o.toString().toLowerCase().includes(n.toLowerCase()):"boolean"==typeof n||"number"==typeof n?o===n:!!Array.isArray(n)&&n.includes(o))}(r,n.searchField,n.searchValue);return o&&t},!0)})}function W(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function O(){return O=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)({}).hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},O.apply(null,arguments)}function N(e){var r=function(e,r){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof r?r:r+""}var H=function(){return null},J=/*#__PURE__*/function(){function e(e,r){this.title=void 0,this.cacheEnabledKey=void 0,this.title=e,this.cacheEnabledKey=r}var r,t,n=e.prototype;return n.isEnabled=function(){return!!localStorage.getItem(this.cacheEnabledKey)},n.SetEnabled=function(e){e?localStorage.setItem(this.cacheEnabledKey,"true"):localStorage.removeItem(this.cacheEnabledKey)},r=e,(t=[{key:"log",get:function(){return this.isEnabled()?console.log.bind(console,this.title):H}},{key:"warn",get:function(){return this.isEnabled()?console.warn.bind(console,this.title):H}},{key:"error",get:function(){return this.isEnabled()?console.error.bind(console,this.title):H}}])&&function(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,N(n.key),n)}}(r.prototype,t),Object.defineProperty(r,"prototype",{writable:!1}),e}(),B=new J("ðŸ’¸firestore-costs:","LOGGING_FIRESTORE_COSTS_ENABLED"),x="firecosts-single-reads",z=new J("ðŸ”¥raf:","LOGGING_ENABLED"),Q=z.log,q=z.error,K=z.warn;function V(e,r,t){var n=document.getElementById("eventMonitor");if(n){var o=new CustomEvent(e,{detail:{fileName:r,data:t}});n.dispatchEvent(o)}else Q("eventMonitor not found to dispatch event "+e+" for "+r)}var $="___REF_FULLPATH_";function X(e){var r={parsedDoc:{},refdocs:[]};return!e||"object"!=typeof e||(Object.keys(e).map(function(t){e[t]=Y(e[t],t,r)}),r.parsedDoc=e),r}function Y(e,r,t){if(!e)return e;if("object"!=typeof e)return e;if(e.toDate&&"function"==typeof e.toDate)return e.toDate();if(Array.isArray(e))return e.map(function(e,n){return Y(e,r+"."+n,t)});if(Z(e)){var n=e;return t.refdocs.push({fieldPath:r,refDocPath:n.path}),n.id}return"object"==typeof e?(Object.keys(e).map(function(r){e[r]=Y(e[r],r,t)}),e):e}function Z(e){return"string"==typeof e.id&&"object"==typeof e.firestore&&"object"==typeof e.parent&&"string"==typeof e.path}var ee=function e(r,n){try{var a,s=function(t){if(a)return t;var o=Array.isArray(n);return o?Promise.all(n.map(function(t,o){return Promise.resolve(e(r,t)).then(function(e){n[o]=e})})):Z(n)?n:o||"object"!=typeof n?void 0:Promise.all(Object.keys(n).map(function(t){try{return Promise.resolve(e(r,n[t])).then(function(e){n[t]=e})}catch(e){return Promise.reject(e)}}))};if(!n||"object"!=typeof n)return Promise.resolve(n);var u=t(n,"src"),c=function(){if(u)return function(e,t){try{var s=Promise.resolve(o(i(r.storage(),n.src))).then(function(e){var r=O({},n,{src:e});return a=1,r})}catch(e){return t(e)}return s&&s.then?s.then(void 0,t):s}(0,function(e){return q("Error when getting download URL",{error:e}),a=1,n})}();return Promise.resolve(c&&c.then?c.then(s):s(c))}catch(e){return Promise.reject(e)}};function re(e){if(!e)return K("parseFireStoreDocument: no doc",{doc:e}),{};var r=X(e.data()),t=function(e,r){return r.map(function(r){n(e,$+r.fieldPath,r.refDocPath)}),e}(r.parsedDoc,r.refdocs);return O({id:e.id},t)}function te(e,r){if(!e)return r+"";if(!r)throw new Error("Resource name must be a string of length greater than 0 characters");var t="string"==typeof e?e:e(),n=u.join("/",t,"/",r,"/");if((n.split("/").length-1)%2)throw new Error('The rootRef path must point to a "document"\n    not a "collection"e.g. /collection/document/ or\n    /collection/document/collection/document/');return n.slice(1,-1)}function ne(){return u.join.apply(u,[].slice.call(arguments))}function oe(e){var r={uploads:[],refdocs:[],parsedDoc:{}};return!e||"object"!=typeof e||(Object.keys(e).map(function(t){ie(e[t],t,r)}),r.parsedDoc=e),r}function ie(e,r,t){return e?"string"==typeof r&&r.includes($)?void t.refdocs.push({fieldDotsPath:r,refPath:e}):"object"!=typeof e?e:e.toDate&&"function"==typeof e.toDate?e.toDate():Array.isArray(e)?e.map(function(e,n){return ie(e,r+"."+n,t)}):e&&e.hasOwnProperty("rawFile")?(t.uploads.push({fieldDotsPath:r,fieldSlashesPath:r.split(".").join("/"),rawFile:e.rawFile}),void delete e.rawFile):(Object.keys(e).map(function(n){ie(e[n],r+"."+n,t)}),e):e}var ae=/*#__PURE__*/function(){function e(e,r){this._app=void 0,this._firestore=void 0,this._storage=void 0,this._auth=void 0,this.options=void 0;var t=e||{};this.options=t,this._app=window._app=function(e,r){if(r.app)return r.app;var t=c();return null!=t&&t.length?l():f(e)}(r,t),this._firestore=y(this._app),this._storage=a(this._app),this._auth=d(this._app)}var r=e.prototype;return r.dbGetCollection=function(e){return b(this._firestore,e)},r.dbCreateBatch=function(){return w(this._firestore)},r.dbMakeNewId=function(){return j(b(this._firestore,"collections")).id},r.OnUserLogout=function(e){this._auth.onAuthStateChanged(function(r){var t=!r;Q("FirebaseWrapper.OnUserLogout",{user:r,isLoggedOut:t}),t&&e(r)})},r.putFile=function(e,r){var t=s(i(this._storage,e),r),n=new Promise(function(e,r){return t.then(e).catch(r)}),a=n.then(function(e){return o(e.ref)}).then(function(e){return e});return{task:t,taskResult:n,downloadUrl:a}},r.getStorageDownloadUrl=function(e){try{return Promise.resolve(o(i(this._storage,e)))}catch(e){return Promise.reject(e)}},r.serverTimestamp=function(){return R()},r.authSetPersistence=function(e){try{var r;switch(e){case"local":r=m;break;case"none":r=v;break;default:r=h}return Q("setPersistence",{persistenceInput:e,persistenceResolved:r}),Promise.resolve(this._auth.setPersistence(r).catch(function(e){return console.error(e)}))}catch(e){return Promise.reject(e)}},r.authSigninEmailPassword=function(e,r){try{return Promise.resolve(p(this._auth,e,r))}catch(e){return Promise.reject(e)}},r.authSignOut=function(){try{return Promise.resolve(g(this._auth))}catch(e){return Promise.reject(e)}},r.authGetUserLoggedIn=function(){try{var e=this;return Promise.resolve(new Promise(function(r,t){var n=e._auth;if(n.currentUser)return r(n.currentUser);var o=P(e._auth,function(e){o(),e?r(e):t()})}))}catch(e){return Promise.reject(e)}},r.GetUserLogin=function(){try{return Promise.resolve(this.authGetUserLoggedIn())}catch(e){return Promise.reject(e)}},r.auth=function(){return this._auth},r.storage=function(){return this._storage},r.GetApp=function(){return this._app},r.db=function(){return this._firestore},e}();function se(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var ue=/*#__PURE__*/function(){function e(e,r){this.fireWrapper=void 0;var t=r||{};Q("Auth Client: initializing...",{firebaseConfig:e,options:t}),this.fireWrapper=new ae(t,e),t.persistence&&this.setPersistence(t.persistence)}var r=e.prototype;return r.setPersistence=function(e){return this.fireWrapper.authSetPersistence(e)},r.HandleAuthLogin=function(e){try{var r=this,t=e.username,n=e.password;return Promise.resolve(t&&n?se(function(){return Promise.resolve(r.fireWrapper.authSigninEmailPassword(t,n)).then(function(e){return Q("HandleAuthLogin: user sucessfully logged in",{user:e}),e})},function(){throw Q("HandleAuthLogin: invalid credentials",{params:e}),new Error("Login error: invalid credentials")}):r.getUserLogin())}catch(e){return Promise.reject(e)}},r.HandleAuthLogout=function(){return this.fireWrapper.authSignOut()},r.HandleAuthError=function(e){return Q("HandleAuthLogin: invalid credentials",{errorHttp:e}),"ok"===function(e){if(e>=200&&e<300)return"ok";switch(e){case 401:case 403:return"unauthenticated";default:return"ok"}}(!!e&&e.status)?(Q("API is actually authenticated"),Promise.resolve()):(K("Received authentication error from API"),Promise.reject())},r.HandleAuthCheck=function(){try{return Promise.resolve(this.getUserLogin())}catch(e){return Promise.reject(e)}},r.getUserLogin=function(){return this.fireWrapper.authGetUserLoggedIn()},r.HandleGetPermissions=function(){try{var e=this;return Promise.resolve(se(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.claims})})},function(e){return Q("HandleGetPermission: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},r.HandleGetIdentity=function(){try{var e=this;return Promise.resolve(se(function(){return Promise.resolve(e.getUserLogin()).then(function(e){var r=e.displayName,t=e.photoURL;return{id:e.uid,fullName:""+(null!=r?r:""),avatar:""+(null!=t?t:"")}})},function(e){return Q("HandleGetIdentity: no user is logged in",{e:e}),null}))}catch(e){return Promise.reject(e)}},r.HandleGetJWTAuthTime=function(){try{var e=this;return Promise.resolve(se(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.authTime})})},function(e){return Q("HandleGetJWTAuthTime: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},r.HandleGetJWTExpirationTime=function(){try{var e=this;return Promise.resolve(se(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.expirationTime})})},function(e){return Q("HandleGetJWTExpirationTime: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},r.HandleGetJWTSignInProvider=function(){try{var e=this;return Promise.resolve(se(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.signInProvider})})},function(e){return Q("HandleGetJWTSignInProvider: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},r.HandleGetJWTIssuedAtTime=function(){try{var e=this;return Promise.resolve(se(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.issuedAtTime})})},function(e){return Q("HandleGetJWTIssuedAtTime: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},r.HandleGetJWTToken=function(){try{var e=this;return Promise.resolve(se(function(){return Promise.resolve(e.getUserLogin()).then(function(e){return Promise.resolve(e.getIdTokenResult()).then(function(e){return e.token})})},function(e){return Q("HandleGetJWTToken: no user is logged in or tokenResult error",{e:e}),null}))}catch(e){return Promise.reject(e)}},e}();function ce(e,r){!function(e,r){if(!(e||r&&r.app))throw new Error("Please pass the Firebase firebaseConfig object or options.app to the FirebaseAuthProvider")}(e,r),z.SetEnabled(!(null==r||!r.logging));var t=new ue(e,r);return{login:function(e){return t.HandleAuthLogin(e)},logout:function(){return t.HandleAuthLogout()},checkAuth:function(){return t.HandleAuthCheck()},checkError:function(e){return t.HandleAuthError(e)},getPermissions:function(){return t.HandleGetPermissions()},getIdentity:function(){return t.HandleGetIdentity()},getAuthUser:function(){return t.getUserLogin()},getJWTAuthTime:function(){return t.HandleGetJWTAuthTime()},getJWTExpirationTime:function(){return t.HandleGetJWTExpirationTime()},getJWTSignInProvider:function(){return t.HandleGetJWTSignInProvider()},getJWTClaims:function(){return t.HandleGetPermissions()},getJWTToken:function(){return t.HandleGetJWTToken()}}}var le=function(e,r,t){try{var n=t.fireWrapper;return Promise.resolve(t.rm.TryGetResource(e)).then(function(o){var i;function a(a){if(i)return a;var s=n.dbMakeNewId();return Promise.resolve(t.parseDataAndUpload(o,s,r.data)).then(function(r){var n=O({},r);return t.checkRemoveIdField(n,s),Promise.resolve(t.addCreatedByFields(n)).then(function(){return Promise.resolve(t.addUpdatedByFields(n)).then(function(){var r=t.transformToDb(e,n,s);return Promise.resolve(L(j(o.collection,s),r,{merge:!1})).then(function(){return{data:O({},r,{id:s})}})})})})}Q("Create",{resourceName:e,resource:o,params:r});var s=r.data&&r.data.id;Q("Create",{hasOverridenDocId:s});var u=function(){if(s){var n=r.data.id;return Promise.resolve(F(j(o.collection,n))).then(function(a){if(a.exists())throw new Error('the id:"'+n+"\" already exists, please use a unique string if overriding the 'id' field");return Promise.resolve(t.parseDataAndUpload(o,n,r.data)).then(function(r){if(!n)throw new Error("id must be a valid string");var a=O({},r);return t.checkRemoveIdField(a,n),Promise.resolve(t.addCreatedByFields(a)).then(function(){return Promise.resolve(t.addUpdatedByFields(a)).then(function(){var r=t.transformToDb(e,a,n);return Q("Create",{docObj:a}),Promise.resolve(L(j(o.collection,n),r,{merge:!1})).then(function(){var e={data:O({},r,{id:n})};return i=1,e})})})})})}}();return u&&u.then?u.then(a):a(u)})}catch(e){return Promise.reject(e)}},fe=function(e,r,t){try{var n=t.rm;return t.options.softDelete?Promise.resolve(function(e,r,t){try{var n=r.id+"";return Promise.resolve(t.rm.TryGetResource(e)).then(function(o){Q("DeleteSoft",{resourceName:e,resource:o,params:r});var i={deleted:!0};return Promise.resolve(t.addUpdatedByFields(i)).then(function(){return T(j(o.collection,n),i).catch(function(e){q("DeleteSoft error",{error:e})}),{data:r.previousData}})})}catch(e){return Promise.reject(e)}}(e,r,t)):Promise.resolve(n.TryGetResource(e)).then(function(t){var n;function o(e){return n?e:{data:r.previousData}}Q("apiDelete",{resourceName:e,resource:t,params:r});var i=function(e,n){try{var o=Promise.resolve(D(j(t.collection,r.id+""))).then(function(){})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){throw new Error(e)});return i&&i.then?i.then(o):o(i)})}catch(e){return Promise.reject(e)}},de=function(e,r,t){try{var n=t.rm,o=t.fireWrapper;return t.options.softDelete?Promise.resolve(function(e,r,t){try{return Promise.resolve(t.rm.TryGetResource(e)).then(function(n){return Q("DeleteManySoft",{resourceName:e,resource:n,params:r}),Promise.resolve(Promise.all(r.ids.map(function(e){try{var r=e+"",o={deleted:!0};return Promise.resolve(t.addUpdatedByFields(o)).then(function(){return T(j(n.collection,r),o).catch(function(e){q("apiSoftDeleteMany error",{error:e})}),r})}catch(e){return Promise.reject(e)}}))).then(function(e){return{data:e}})})}catch(e){return Promise.reject(e)}}(e,r,t)):Promise.resolve(n.TryGetResource(e)).then(function(t){var n;function i(e){return n?e:{data:s}}Q("DeleteMany",{resourceName:e,resource:t,params:r});for(var a,s=[],u=o.dbCreateBatch(),c=function(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return W(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?W(e,r):void 0}}(e))){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(r.ids);!(a=c()).done;){var l=a.value,f=j(t.collection,l+"");u.delete(f),s.push(l)}var d=function(e,r){try{var t=Promise.resolve(u.commit()).then(function(){})}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}(0,function(e){throw new Error(e)});return d&&d.then?d.then(i):i(d)})}catch(e){return Promise.reject(e)}},he=function(e,r,t){try{var n=t.rm;Q("Update",{resourceName:e,params:r});var o=r.id+"";return delete r.data.id,Promise.resolve(n.TryGetResource(e)).then(function(n){return Q("Update",{resourceName:e,resource:n,params:r}),Promise.resolve(t.parseDataAndUpload(n,o,r.data)).then(function(r){var i=O({},r);return t.checkRemoveIdField(i,o),Promise.resolve(t.addUpdatedByFields(i)).then(function(){var a=t.transformToDb(e,i,o);return Promise.resolve(T(j(n.collection,o),a)).then(function(){return{data:O({},r,{id:o})}})})})})}catch(e){return Promise.reject(e)}},ve=function(e,r,t){try{var n=t.rm;return Q("UpdateMany",{resourceName:e,params:r}),delete r.data.id,Promise.resolve(n.TryGetResource(e)).then(function(n){return Q("UpdateMany",{resourceName:e,resource:n,params:r}),Promise.resolve(Promise.all(r.ids.map(function(o){try{var i=o+"";return Promise.resolve(t.parseDataAndUpload(n,i,r.data)).then(function(r){var o=O({},r);return t.checkRemoveIdField(o,i),Promise.resolve(t.addUpdatedByFields(o)).then(function(){var a=t.transformToDb(e,o,i);return Promise.resolve(T(j(n.collection,i),a)).then(function(){return O({},r,{id:i})})})})}catch(e){return Promise.reject(e)}}))).then(function(e){return{data:e}})})}catch(e){return Promise.reject(e)}},me=/*#__PURE__*/function(){function e(e,r,t){var n=this;this.fireWrapper=void 0,this.options=void 0,this.flogger=void 0,this.resources={},this.fireWrapper=e,this.options=r,this.flogger=t,this.fireWrapper.OnUserLogout(function(){n.resources={}})}var r=e.prototype;return r.TryGetResource=function(e,r,t){try{var n=function(){return o.TryGetResourcePromise(e,t)},o=this,i=function(){if(r)return Promise.resolve(o.RefreshResource(e,t)).then(function(){})}();return Promise.resolve(i&&i.then?i.then(n):n())}catch(e){return Promise.reject(e)}},r.GetResource=function(e){var r=this.resources[e];if(!r)throw new Error("react-admin-firebase: Can't find resource: \""+e+'"');return r},r.TryGetResourcePromise=function(e,r){try{var t=this;return Q("resourceManager.TryGetResourcePromise",{relativePath:e,collectionQuery:r}),Promise.resolve(t.initPath(e)).then(function(){var r=t.resources[e];if(!r)throw new Error('react-admin-firebase: Cant find resource: "'+e+'"');return r})}catch(e){return Promise.reject(e)}},r.RefreshResource=function(e,r){try{var t,n,o=this;if(null!=(t=o.options)&&null!=(n=t.lazyLoading)&&n.enabled)throw K("resourceManager.RefreshResource",{warn:"RefreshResource is not available in lazy loading mode"}),new Error("react-admin-firebase: RefreshResource is not available in lazy loading mode");return Q("resourceManager.RefreshResource",{relativePath:e,collectionQuery:r}),Promise.resolve(o.initPath(e)).then(function(){var t=o.resources[e],n=t.collection,i=o.applyQuery(n,r);return Promise.resolve(E(i)).then(function(e){t.list=[],e.forEach(function(e){return t.list.push(re(e))}),o.flogger.logDocument(e.docs.length)(),Q("resourceManager.RefreshResource",{newDocs:e,resource:t,collectionPath:n.path})})})}catch(e){return Promise.reject(e)}},r.GetSingleDoc=function(e,r){try{var t=this;return Promise.resolve(t.initPath(e)).then(function(){var n=t.GetResource(e);return t.flogger.logDocument(1)(),Promise.resolve(F(j(n.collection,r))).then(function(t){if(!t.exists)throw new Error("react-admin-firebase: No id found matching: "+r);var o=re(t);return Q("resourceManager.GetSingleDoc",{relativePath:e,resource:n,docId:r,docSnap:t,result:o}),o})})}catch(e){return Promise.reject(e)}},r.initPath=function(e){try{var r=this,t=te(r.options&&r.options.rootRef,e),n=!!r.resources[e];if(Q("resourceManager.initPath()",{absolutePath:t,hasBeenInited:n}),n)return Q("resourceManager.initPath() has been initialized already..."),Promise.resolve();var o=r.fireWrapper.dbGetCollection(t),i={collection:o,list:[],path:e,pathAbsolute:t};return r.resources[e]=i,Q("resourceManager.initPath() setting resource...",{resource:i,allResources:r.resources,collection:o,collectionPath:o.path}),Promise.resolve()}catch(e){return Promise.reject(e)}},r.getUserIdentifier=function(){try{var e=this;return Promise.resolve(e.options.associateUsersById?e.getCurrentUserId():e.getCurrentUserEmail())}catch(e){return Promise.reject(e)}},r.getCurrentUserEmail=function(){try{return Promise.resolve(this.fireWrapper.authGetUserLoggedIn()).then(function(e){return e?e.email:"annonymous user"})}catch(e){return Promise.reject(e)}},r.getCurrentUserId=function(){try{return Promise.resolve(this.fireWrapper.authGetUserLoggedIn()).then(function(e){return e?e.uid:"annonymous user"})}catch(e){return Promise.reject(e)}},r.applyQuery=function(e,r){var t=r?r(e):e;return Q("resourceManager.applyQuery() ...",{collection:e,collectionQuery:(r||"-").toString(),collRef:t}),t},e}(),pe=/*#__PURE__*/function(){function r(e,r,t){this.fireWrapper=void 0,this.options=void 0,this.flogger=void 0,this.rm=void 0,this.fireWrapper=e,this.options=r,this.flogger=t,this.rm=new me(this.fireWrapper,this.options,this.flogger)}var t=r.prototype;return t.checkRemoveIdField=function(e,r){this.options.dontAddIdFieldToDoc||(e.id=r)},t.transformToDb=function(e,r,t){return"function"==typeof this.options.transformToDb?this.options.transformToDb(e,r,t):r},t.parseDataAndUpload=function(e,r,t){try{var o=this;if(!t)return Promise.resolve(t);var i=j(e.collection,r).path,a=oe(t);return Promise.resolve(Promise.all(a.uploads.map(function(e){try{var r=function(e,r,t,n){var o=e instanceof File?e.name.split("."):[],i=null!=o&&o.length?"."+o.pop():"";return n?ne(r,t,e.name):ne(r,t+i)}(e.rawFile,i,e.fieldDotsPath,!!o.options.useFileNamesInStorage);return Promise.resolve(o.saveFile(r,e.rawFile)).then(function(r){n(t,e.fieldDotsPath+".src",r)})}catch(e){return Promise.reject(e)}}))).then(function(){return t})}catch(e){return Promise.reject(e)}},t.addCreatedByFields=function(e){try{var r=this;return Promise.resolve(function(e,r,t,n){try{return n.disableMeta?Promise.resolve():Promise.resolve(t.getUserIdentifier()).then(function(t){var o=function(e){if(e.renameMetaFields&&e.renameMetaFields.created_at)return e.renameMetaFields.created_at;var r=e.metaFieldCasing,t="createdate";return r?"camel"===r?"createDate":"snake"===r?"create_date":"pascal"===r?"CreateDate":"kebab"===r?"create-date":t:t}(n),i=function(e){if(e.renameMetaFields&&e.renameMetaFields.created_by)return e.renameMetaFields.created_by;var r=e.metaFieldCasing,t="createdby";return r?"camel"===r?"createdBy":"snake"===r?"created_by":"pascal"===r?"CreatedBy":"kebab"===r?"created-by":t:t}(n);e[o]=r.serverTimestamp(),e[i]=t})}catch(e){return Promise.reject(e)}}(e,r.fireWrapper,r.rm,r.options))}catch(e){return Promise.reject(e)}},t.addUpdatedByFields=function(e){try{var r=this;return Promise.resolve(function(e,r,t,n){try{return n.disableMeta?Promise.resolve():Promise.resolve(t.getUserIdentifier()).then(function(t){var o=function(e){if(e.renameMetaFields&&e.renameMetaFields.updated_at)return e.renameMetaFields.updated_at;var r=e.metaFieldCasing,t="lastupdate";return r?"camel"===r?"lastUpdate":"snake"===r?"last_update":"pascal"===r?"LastUpdate":"kebab"===r?"last-update":t:t}(n),i=function(e){if(e.renameMetaFields&&e.renameMetaFields.updated_by)return e.renameMetaFields.updated_by;var r=e.metaFieldCasing,t="updatedby";return r?"camel"===r?"updatedBy":"snake"===r?"updated_by":"pascal"===r?"UpdatedBy":"kebab"===r?"updated-by":t:t}(n);e[o]=r.serverTimestamp(),e[i]=t})}catch(e){return Promise.reject(e)}}(e,r.fireWrapper,r.rm,r.options))}catch(e){return Promise.reject(e)}},t.saveFile=function(r,t){try{var n=this;return Q("saveFile() saving file...",{storagePath:r,rawFile:t}),Promise.resolve(function(e,o){try{var i=(s=(a=n.fireWrapper.putFile(r,t)).task,u=a.taskResult,c=a.downloadUrl,V("FILE_UPLOAD_WILL_START",l=t.name),s.on("state_changed",function(e){var r=e.bytesTransferred/e.totalBytes*100;switch(Q("Upload is "+r+"% done"),V("FILE_UPLOAD_PROGRESS",l,r),e.state){case"paused":Q("Upload is paused"),V("FILE_UPLOAD_PAUSED",l);break;case"running":Q("Upload is running"),V("FILE_UPLOAD_RUNNING",l);break;case"cancelled":Q("Upload has been canceled"),V("FILE_UPLOAD_CANCELED",l)}}),Promise.resolve(Promise.all([c,u])).then(function(e){var t=e[0];return V("FILE_UPLOAD_COMPLETE",l),V("FILE_SAVED",l),Q("saveFile() saved file",{storagePath:r,taskResult:u,getDownloadURL:t}),n.options.relativeFilePaths?r:t}))}catch(e){return o(e)}var a,s,u,c,l;return i&&i.then?i.then(void 0,o):i}(0,function(r){"storage/unknown"===e(r,"code")?q('saveFile() error saving file, No bucket found! Try clicking "Get Started" in firebase -> storage',{storageError:r}):q("saveFile() error saving file",{storageError:r})}))}catch(e){return Promise.reject(e)}},r}();function ge(e,r,t){if(!e.s){if(t instanceof Pe){if(!t.s)return void(t.o=ge.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(ge.bind(null,e,r),ge.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}var Pe=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){var n=new e,o=this.s;if(o){var i=1&o?r:t;if(i){try{ge(n,1,i(this.v))}catch(e){ge(n,2,e)}return n}return this}return this.o=function(e){try{var o=e.v;1&e.s?ge(n,1,r?r(o):o):t?ge(n,1,t(o)):ge(n,2,o)}catch(e){ge(n,2,e)}},n},e}();function ye(e){return e instanceof Pe&&1&e.s}var be=function(e,r,t,n){try{var o=btoa(JSON.stringify(O({},r,{resourceName:t}))),i=localStorage.getItem(o);return i?Promise.resolve(F(j(e,i))).then(function(e){return n.logDocument(1)(),!!e.exists()&&e}):Promise.resolve(!1)}catch(e){return Promise.reject(e)}},we=function(e,r,t,n,o){void 0===o&&(o=je);try{var i=function(r){return{noPagination:G.apply(void 0,[e].concat([].concat(a,s))),withPagination:G.apply(void 0,[e].concat([].concat(a,s,r)))}},a=o.filters?(u=r.filter,Object.entries(u).flatMap(function(e){var r=e[0],t=e[1];return Array.isArray(t)?[U(r,"array-contains-any",t)]:1===Object.keys(u).length&&isNaN(t)?[U(r,">=",t),U(r,"<",t+"z")]:[U(r,"==",t)]})):[],s=o.sort?function(e){if(null!=e&&"id"!==e.field){var r=e.field,t=e.order.toLocaleLowerCase();return[S(r,t)]}return[]}(r.sort):[];return Promise.resolve(o.pagination?Promise.resolve(function(e,r,t,n,o){try{if(!t.pagination)throw new Error("getPaginationConstraints: params.pagination is required but was not provided.");var i=t.pagination,a=i.perPage;return 1===i.page?Promise.resolve([A(a)]):Promise.resolve(be(e,t,n,o)).then(function(i){function s(){return[I(i),A(a)]}var u=function(){if(!i)return Promise.resolve(function(e,r,t,n,o){try{var i=function(){var t=(s-l)*u,n=G.apply(void 0,[e].concat([].concat(r,1===l?[A(t)]:[I(c),A(t)])));return Promise.resolve(E(n)).then(function(e){var r=e.docs.length;return o.logDocument(r)(),e.docs[r-1]})};if(!t.pagination)throw new Error("findLastQueryCursor: params.pagination is required but was not provided.");var a=t.pagination,s=a.page,u=a.perPage,c=!1,l=s-1,f=O({},t,{pagination:O({},t.pagination)}),d=function(e,r,t){for(var n;;){var o=e();if(ye(o)&&(o=o.v),!o)return i;if(o.then){n=0;break}var i=t();if(i&&i.then){if(!ye(i)){n=1;break}i=i.s}if(r){var a=r();if(a&&a.then&&!ye(a)){n=2;break}}}var s=new Pe,u=ge.bind(null,s,2);return(0===n?o.then(l):1===n?i.then(c):a.then(f)).then(void 0,u),s;function c(n){i=n;do{if(r&&(a=r())&&a.then&&!ye(a))return void a.then(f).then(void 0,u);if(!(o=e())||ye(o)&&!o.v)return void ge(s,1,i);if(o.then)return void o.then(l).then(void 0,u);ye(i=t())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,u)}function l(e){e?(i=t())&&i.then?i.then(c).then(void 0,u):c(i):ge(s,1,i)}function f(){(o=e())?o.then?o.then(l).then(void 0,u):l(o):ge(s,1,i)}}(function(){return!c&&l>1},void 0,function(){return l--,f.pagination.page=l,console.log("getting query cursor currentPage=",l),Promise.resolve(be(e,f,n,o)).then(function(e){c=e})});return Promise.resolve(d&&d.then?d.then(i):i())}catch(e){return Promise.reject(e)}}(e,r,t,n,o)).then(function(e){i=e})}();return u&&u.then?u.then(s):s()})}catch(e){return Promise.reject(e)}}(e,[].concat(a,s),r,t,n)).then(i):i([]))}catch(e){return Promise.reject(e)}var u},je={filters:!0,sort:!0,pagination:!0};function Re(e,r){return O({},e,{filter:r?O({deleted:!1},e.filter):e.filter})}function Le(e,r,t){if(!e.s){if(t instanceof Fe){if(!t.s)return void(t.o=Le.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(Le.bind(null,e,r),Le.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}var Fe=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){var n=new e,o=this.s;if(o){var i=1&o?r:t;if(i){try{Le(n,1,i(this.v))}catch(e){Le(n,2,e)}return n}return this}return this.o=function(e){try{var o=e.v;1&e.s?Le(n,1,r?r(o):o):t?Le(n,1,t(o)):Le(n,2,o)}catch(e){Le(n,2,e)}},n},e}();function Te(e,r,t){var n=[];for(var o in e)n.push(o);return function(e,r,t){var n,o,i=-1;return function a(s){try{for(;++i<e.length&&(!t||!t());)if((s=r(i))&&s.then){if(!((u=s)instanceof Fe&&1&u.s))return void s.then(a,o||(o=Le.bind(null,n=new Fe,2)));s=s.v}n?Le(n,1,s):n=s}catch(e){Le(n||(n=new Fe),2,e)}var u}(),n}(n,function(e){return r(n[e])},t)}var De=/*#__PURE__*/function(){function e(e,r,t){this.options=void 0,this.rm=void 0,this.client=void 0,this.options=e,this.rm=r,this.client=t}var r=e.prototype;return r.apiGetList=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){var o=Re(O({},r,{sort:r.sort?O({},r.sort,{order:r.sort.order.toUpperCase()}):void 0}),!!t.options.softDelete);return Q("apiGetListLazy",{resourceName:e,params:o}),Promise.resolve(we(n.collection,o,e,t.client.flogger)).then(function(r){var i=r.noPagination;return Promise.resolve(E(r.withPagination)).then(function(r){var a=r.docs.length;if(!a)return Q("apiGetListLazy",{message:"There are not records for given query"}),{data:[],total:0};t.client.flogger.logDocument(a)();var s=r.docs.map(function(e){return re(e)});return function(e,r,t){var n=btoa(JSON.stringify(O({},r,{resourceName:t})));localStorage.setItem(n,e.id);var o="ra-firebase-cursor-keys_"+t,i=localStorage.getItem(o);if(i){var a=JSON.parse(i).concat(n);localStorage.setItem(o,JSON.stringify(a))}else localStorage.setItem(o,JSON.stringify([n]))}(r.docs[r.docs.length-1],function(e){if(!e.pagination)throw new Error("getNextPageParams: params.pagination is required but was not provided.");return O({},e,{pagination:O({},e.pagination,{page:e.pagination.page+1})})}(o),e),Promise.resolve(k(i)).then(function(e){var r;function o(t){return r?t:(Q("apiGetListLazy result",{docs:s,resource:n,collectionPath:n.collection.path}),{data:s,total:e.data().count})}var i=function(){if(t.options.relativeFilePaths)return Promise.resolve(Promise.all(s.map(function(e){try{var r=Te(e,function(r){return Promise.resolve(ee(t.client.fireWrapper,e[r])).then(function(t){e[r]=t})});return Promise.resolve(r&&r.then?r.then(function(){return e}):e)}catch(e){return Promise.reject(e)}}))).then(function(t){Q("apiGetListLazy result",{docs:t,resource:n,collectionPath:n.collection.path});var o={data:t,total:e.data().count};return r=1,o})}();return i&&i.then?i.then(o):o(i)})})})})}catch(e){return Promise.reject(e)}},r.apiGetManyReference=function(e,r){try{var t=this;return Promise.resolve(t.tryGetResource(e)).then(function(n){var o;Q("apiGetManyReferenceLazy",{resourceName:e,resource:n,reactAdminParams:r});var i=O({},r.filter,((o={})[r.target]=r.id,o)),a=Re(O({},r,{filter:i}),!!t.options.softDelete);return Promise.resolve(we(n.collection,a,e,t.client.flogger)).then(function(e){return Promise.resolve(E(e.withPagination)).then(function(e){var r;function o(e){return r?e:(Q("apiGetManyReferenceLazy result",{docs:i,resource:n,collectionPath:n.collection.path}),{data:i,total:i.length})}t.client.flogger.logDocument(e.docs.length)();var i=e.docs.map(re),a=function(){if(t.options.relativeFilePaths)return Promise.resolve(Promise.all(i.map(function(e){try{var r=Te(e,function(r){return Promise.resolve(ee(t.client.fireWrapper,e[r])).then(function(t){e[r]=t})});return Promise.resolve(r&&r.then?r.then(function(){return e}):e)}catch(e){return Promise.reject(e)}}))).then(function(e){return Q("apiGetManyReferenceLazy result",{docs:e,resource:n,collectionPath:n.collection.path}),r=1,{data:e,total:i.length}})}();return a&&a.then?a.then(o):o(a)})})})}catch(e){return Promise.reject(e)}},r.tryGetResource=function(e,r){try{return Promise.resolve(this.rm.TryGetResourcePromise(e,r))}catch(e){return Promise.reject(e)}},e}(),Ee=function(e,r,t){try{var n;Q("GetList",{resourceName:e,params:r});var o=t.rm,i=t.fireWrapper,a=t.options;if(null!=a&&null!=(n=a.lazyLoading)&&n.enabled){var s=new De(a,o,t);return Promise.resolve(s.apiGetList(e,r))}var u=r.filter||{},c=u.collectionQuery;return delete u.collectionQuery,Promise.resolve(o.TryGetResource(e,"REFRESH",c)).then(function(e){var t;function n(e){return t?e:{data:d,total:h}}var o=e.list;if(null!=r.sort){var s=r.sort;_(o,s.field,"ASC"===s.order?"asc":"desc")}var c=o;a.softDelete&&!Object.keys(u).includes("deleted")&&(c=o.filter(function(e){return!e.deleted}));var l=M(c,u);if(!r.pagination)throw new Error("GetList: params.pagination is required but was not provided.");var f=(r.pagination.page-1)*r.pagination.perPage,d=l.slice(f,f+r.pagination.perPage),h=l.length,v=function(){if(a.relativeFilePaths)return Promise.resolve(Promise.all(d.map(function(e){return ee(i,e)}))).then(function(e){return t=1,{data:e,total:h}})}();return v&&v.then?v.then(n):n(v)})}catch(e){return Promise.reject(e)}},Ge=function(e,r,t){try{var n=t.options,o=t.fireWrapper;return Promise.resolve(t.rm.TryGetResource(e)).then(function(i){var a=r.ids;return Q("GetMany",{resourceName:e,resource:i,params:r,ids:a}),Promise.resolve(Promise.all(a.map(function(e){return F(j(i.collection,"string"==typeof e?e:e.___refid))}))).then(function(e){var r;function i(e){return r?e:{data:u}}t.flogger.logDocument(a.length)();var s=e.map(function(e){return O({},e.data(),{id:e.id})}),u=n.softDelete?s.filter(function(e){return!e.deleted}):s,c=function(){if(n.relativeFilePaths)return Promise.resolve(Promise.all(u.map(function(e){return ee(o,e)}))).then(function(e){return r=1,{data:e}})}();return c&&c.then?c.then(i):i(c)})})}catch(e){return Promise.reject(e)}},Ae=function(e,r,t){try{var n=t.rm,o=t.options,i=t.fireWrapper;Q("GetManyReference",{resourceName:e,params:r});var a=r.filter||{};return Promise.resolve(n.TryGetResource(e,"REFRESH",a.collectionQuery)).then(function(t){var n;function s(e){return n?e:{data:g,total:P}}delete a.collectionQuery,Q("apiGetManyReference",{resourceName:e,resource:t,params:r});var u=t.list,c=r.target,l=r.id,f=u;o.softDelete&&(f=u.filter(function(e){return!e.deleted}));var d=M(f,a),h={};h[c]=l;var v=M(d,h);if(null!=r.sort){var m=r.sort;_(v,m.field,"ASC"===m.order?"asc":"desc")}var p=(r.pagination.page-1)*r.pagination.perPage,g=v.slice(p,p+r.pagination.perPage),P=v.length,y=function(){if(o.relativeFilePaths)return Promise.resolve(Promise.all(v.map(function(e){return ee(i,e)}))).then(function(e){return n=1,{data:e,total:P}})}();return y&&y.then?y.then(s):s(y)})}catch(e){return Promise.reject(e)}},Ie=function(e,r,t){try{Q("GetOne",{resourceName:e,params:r});var n=t.rm;return Promise.resolve(function(o,i){try{var a=Promise.resolve(n.GetSingleDoc(e,r.id+"")).then(function(e){return t.flogger.logDocument(1)(),{data:e}})}catch(e){return i()}return a&&a.then?a.then(void 0,i):a}(0,function(){throw new Error("Error getting id: "+r.id+" from collection: "+e)}))}catch(e){return Promise.reject(e)}};function Ue(e,r){var t,n,o=function(e){try{var r;return Promise.resolve(function(t,n){try{var o=Promise.resolve(e()).then(function(e){return r=e})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){var t=(e||"").toString(),n=function(e){var r=/\[code\=([\w-]*)/g.exec(e),t=Array.isArray(r)&&r[1];switch(t||q("unknown StatusCode ",{statusTxt:e}),t){case"unauthenticated":return 401;case"permission-denied":return 403;case"internal":return 0;case"invalid-argument":return 400;case"not-found":return 404;case"aborted":return 409;case"resource-exhausted":return 429;case"cancelled":return 499;case"internal":return 500;case"unimplemented":return 501;case"unavailable":return 503;case"deadline-exceeded":return 504;default:return 200}}(t),o={status:n,message:t,json:r};throw q("DataProvider:",e,{errorMsg:t,code:n,errorObj:o}),o}))}catch(e){return Promise.reject(e)}},i=r||{};!function(e,r){if(!(e||r&&r.app))throw new Error("Please pass the Firebase firebaseConfig object or options.app to the FirebaseAuthProvider");r&&r.rootRef&&te(r.rootRef,"test")}(e,i);var a=function(e){return{SetEnabled:function(e){B.SetEnabled(e)},ResetCount:function(e){e&&localStorage.removeItem(x)},logDocument:function(r){if(null==e||null==(t=e.lazyLoading)||!t.enabled)return H;var t,n=function(e){void 0===e&&(e=1);var r=localStorage.getItem(x)||"",t=(parseInt(r)||0)+e;return localStorage.setItem(x,t+""),t}(r);return B.log.bind(console,"+"+r+" (session total="+n+" documents read)")}}}(i);z.SetEnabled(!(null==i||!i.logging)),a.SetEnabled(!(null==i||null==(t=i.firestoreCostsLogger)||!t.enabled)),a.ResetCount(!(null!=i&&null!=(n=i.firestoreCostsLogger)&&n.persistCount)),Q("Creating FirebaseDataProvider",{firebaseConfig:e,options:i});var s=new ae(r,e),u=new pe(s,i,a);return{app:s.GetApp(),getList:function(e,r){return o(function(){return Ee(e,r,u)})},getOne:function(e,r){return o(function(){return Ie(e,r,u)})},getMany:function(e,r){return o(function(){return Ge(e,r,u)})},getManyReference:function(e,r){return o(function(){return Ae(e,r,u)})},update:function(e,r){return o(function(){return he(e,r,u)})},updateMany:function(e,r){return o(function(){return ve(e,r,u)})},create:function(e,r){return o(function(){return le(e,r,u)})},delete:function(e,r){return o(function(){return fe(e,r,u)})},deleteMany:function(e,r){return o(function(){return de(e,r,u)})}}}export{ce as FirebaseAuthProvider,Ue as FirebaseDataProvider};
//# sourceMappingURL=index.esm.mjs.map
